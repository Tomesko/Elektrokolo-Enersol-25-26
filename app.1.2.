import streamlit as st
import pandas as pd
import math

# --- KONSTANTY (Fyzika) ---
CDA = 0.45            # Aerodynamick√Ω koeficient
CRR = 0.008           # Valiv√Ω odpor
RHO = 1.225           # Hustota vzduchu
G = 9.81              # Gravitace
EFF_MOTOR = 0.85      # √öƒçinnost motoru
EFF_PANEL = 0.70      # √öƒçinnost panelu

st.set_page_config(page_title="Solar Bike Thesis", layout="wide")

# ==============================================================================
# --- ZMƒöNA ZDE: NOV√â √öROVNƒö ASISTENCE (0% a≈æ 100%) ---
# ==============================================================================
# Hodnota 1.0 znamen√° 100% dopomoc (Motor d√°v√° to sam√©, co ƒçlovƒõk = 1:1)
# Hodnota 0.0 znamen√° 0% dopomoc (Motor ned√°v√° nic)

REZIMY_ASISTENCE = {
    "Vypnuto": 0.0,
    "√örove≈à 1 (0%)": 0.0,      # Motor je "Ready", ale nep≈ôid√°v√° s√≠lu
    "√örove≈à 2 (25%)": 0.25,    # Motor p≈ôid√°v√° ƒçtvrtinu tv√© s√≠ly
    "√örove≈à 3 (50%)": 0.50,    # Motor p≈ôid√°v√° polovinu tv√© s√≠ly
    "√örove≈à 4 (75%)": 0.75,    # Motor p≈ôid√°v√° t≈ôi ƒçtvrtiny tv√© s√≠ly
    "√örove≈à 5 - Boost (100%)": 1.0 # Motor dorovn√°v√° tvou s√≠lu (1:1)
}

# --- DATA LOKALIT ---
LOKALITA_DATA = {
    "Hostou≈à (Rovina)":      {"sklon": 0.5, "osvit": 3.8},
    "Praha (M√≠rn√© kopce)":   {"sklon": 1.5, "osvit": 3.5},
    "Brno (Zvlnƒõn√©)":        {"sklon": 2.5, "osvit": 3.6},
    "≈†umava (Hory)":         {"sklon": 5.0, "osvit": 3.0},
    "Vlastn√≠ nastaven√≠":     {"sklon": 0.0, "osvit": 0.0}
}

# --- SIDEBAR: VSTUPN√ç PARAMETRY ---
st.sidebar.header("‚öôÔ∏è 1) Parametry j√≠zdy")
hmotnost = st.sidebar.number_input("Celkov√° hmotnost (kg)", value=100)
rychlost_kmh = st.sidebar.number_input("Pr≈Øm. rychlost (km/h)", value=25)

st.sidebar.markdown("---")
st.sidebar.caption("üîß Kalibrace re√°ln√©ho dojezdu")
# Koeficient 1.8 pro kompenzaci re√°ln√Ωch ztr√°t
koeficient_realnosti = st.sidebar.slider("Koeficient n√°roƒçnosti", 1.0, 3.0, 1.8, 0.1)

st.sidebar.header("üîã 2) Baterie a Motor")
napeti_v = st.sidebar.number_input("Napƒõt√≠ baterie [V]", value=36)
kapacita_wh = st.sidebar.number_input("Kapacita baterie [Wh]", value=500)

# V√Ωbƒõr re≈æimu (z nov√© tabulky v√Ω≈°e)
nazev_rezimu = st.sidebar.selectbox("Re≈æim asistence", list(REZIMY_ASISTENCE.keys()), index=3) # Default na 50%
support_ratio = REZIMY_ASISTENCE[nazev_rezimu]

vykon_motoru_nom = st.sidebar.number_input("Nomin√°ln√≠ v√Ωkon motoru [W]", value=250)

st.sidebar.header("‚òÄÔ∏è 3) Sol√°r a Lokalita")
vykon_panelu_wp = st.sidebar.number_input("Nomin√°ln√≠ v√Ωkon solar. panelu [Wp]", value=100)
lokalita = st.sidebar.selectbox("Lokalita", list(LOKALITA_DATA.keys()))

if lokalita == "Vlastn√≠ nastaven√≠":
    sklon_proc = st.sidebar.slider("Ter√©n - Sklon [%]", -5.0, 15.0, 0.0)
    dodana_energie_wh = st.sidebar.number_input("Dodan√° energie z osvitu [Wh]", value=150)
else:
    data = LOKALITA_DATA[lokalita]
    sklon_proc = data["sklon"]
    osvit_regionu = data["osvit"]
    dodana_energie_wh = vykon_panelu_wp * osvit_regionu * EFF_PANEL
    st.sidebar.info(f"üìç {lokalita}: Sklon {sklon_proc}%")


# ==============================================================================
# --- V√ùPOƒåTY ---
# ==============================================================================

v_ms = rychlost_kmh / 3.6

# 1. Odpory
F_air = 0.5 * RHO * (v_ms**2) * CDA
F_roll = hmotnost * G * CRR
F_slope = hmotnost * G * math.sin(math.atan(sklon_proc/100))
F_total = F_air + F_roll + F_slope
if F_total < 0: F_total = 0

# 2. Mechanick√Ω v√Ωkon (vƒçetnƒõ kalibrace)
P_mech_total = F_total * v_ms
P_mech_real = P_mech_total * koeficient_realnosti

# 3. Rozdƒõlen√≠ pr√°ce (Motor vs ƒålovƒõk)
if P_mech_real > 0:
    # Vzorec: P_human + (P_human * support_ratio) = P_total
    # Pokud je support_ratio 0 (Level 1), pak P_human = P_total (v≈°e ≈°lape≈° ty)
    # Pokud je support_ratio 1 (Level 5), pak P_human = P_total / 2 (p≈Øl nap≈Øl)
    P_human = P_mech_real / (1 + support_ratio)
    P_motor_req = P_mech_real - P_human
else:
    P_human = 0
    P_motor_req = 0

# 4. Elektrick√° spot≈ôeba
P_motor_final = min(P_motor_req, vykon_motoru_nom)
P_elec_battery = P_motor_final / EFF_MOTOR

# Korekce pro ƒçlovƒõka (pokud motor nestaƒç√≠)
if P_motor_req > vykon_motoru_nom:
    P_human = P_mech_real - P_motor_final

# 5. Dojezdy
spotreba_wh_km = P_elec_battery / rychlost_kmh if rychlost_kmh > 0 else 0
dojezd_bat = kapacita_wh / spotreba_wh_km if spotreba_wh_km > 0 else 0
dojezd_solar = (kapacita_wh + dodana_energie_wh) / spotreba_wh_km if spotreba_wh_km > 0 else 0
bonus_km = dojezd_solar - dojezd_bat

# ==============================================================================
# --- DASHBOARD ---
# ==============================================================================

st.title("üîã Solar Bike Thesis: Kalibrace")
st.markdown(f"**Nastaven√≠:** {nazev_rezimu} | **Pomƒõr pomoci:** {support_ratio*100:.0f} %")

m1, m2, m3 = st.columns(3)
m1.metric("Spot≈ôeba energie", f"{spotreba_wh_km:.1f} Wh/km")
m2.metric("Dojezd (Jen Baterie)", f"{dojezd_bat:.1f} km")
m3.metric("Dojezd (+ Sol√°r)", f"{dojezd_solar:.1f} km", delta=f"+{bonus_km:.1f} km")

st.divider()

c_graf, c_info = st.columns([2, 1])

with c_graf:
    st.subheader("Simulace dojezdu")
    df = pd.DataFrame({'Zdroj': ['Jen Baterie', 'Baterie + Sol√°r'], 'Dojezd (km)': [dojezd_bat, dojezd_solar]})
    st.bar_chart(df.set_index('Zdroj'))

with c_info:
    st.subheader("V√Ωkonov√° bilance")
    st.write(f"üö¥ **Jezdec:** {P_human:.0f} W")
    st.write(f"‚ö° **Motor:** {P_motor_final:.0f} W")
    st.write(f"üîã **Odbƒõr:** {P_elec_battery:.0f} W")
    
    st.markdown("---")
    st.caption("Legenda asistence:")
    st.caption("0% = V≈°echno ≈°lape≈° ty")
    st.caption("100% = Motor d√°v√° stejnƒõ jako ty")
