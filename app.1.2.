import streamlit as st
import pandas as pd
import math

# --- KONSTANTY (Fyzika) ---
CDA = 0.45            # Aerodynamick√Ω koeficient (odpor tvaru jezdce a kola)
CRR = 0.008           # Koeficient valiv√©ho odporu (t≈ôen√≠ pneumatik o asfalt)
RHO = 1.225           # Hustota vzduchu (kg/m3)
G = 9.81              # Gravitaƒçn√≠ zrychlen√≠ (m/s2)
EFF_MOTOR = 0.85      # √öƒçinnost elektromotoru (ztr√°ty teplem v motoru a ≈ôadiƒçi)
EFF_PANEL = 0.70      # Re√°ln√° √∫ƒçinnost panelu (ztr√°ty √∫hlem, teplotou, regul√°torem)

st.set_page_config(page_title="Solar Bike Thesis", layout="wide")

# --- DATA: 5 √öROVN√ç ASISTENCE ---
REZIMY_ASISTENCE = {
    "Vypnuto (0%)": 0.0,
    "√örove≈à 1 - Eco (50%)": 0.5,
    "√örove≈à 2 - Tour (100%)": 1.0,
    "√örove≈à 3 - Sport (150%)": 1.5,
    "√örove≈à 4 - Turbo (200%)": 2.0,
    "√örove≈à 5 - Boost (300%)": 3.0
}

# --- DATA LOKALIT ---
LOKALITA_DATA = {
    "Hostou≈à (Rovina)":      {"sklon": 0.5, "osvit": 3.8},
    "Praha (M√≠rn√© kopce)":   {"sklon": 1.5, "osvit": 3.5},
    "Brno (Zvlnƒõn√©)":        {"sklon": 2.5, "osvit": 3.6},
    "≈†umava (Hory)":         {"sklon": 5.0, "osvit": 3.0},
    "Vlastn√≠ nastaven√≠":     {"sklon": 0.0, "osvit": 0.0}
}

# --- SIDEBAR: VSTUPN√ç PARAMETRY ---
st.sidebar.header("‚öôÔ∏è 1) Parametry j√≠zdy")
hmotnost = st.sidebar.number_input("Celkov√° hmotnost (kg)", value=100)
rychlost_kmh = st.sidebar.number_input("Pr≈Øm. rychlost (km/h)", value=25)

st.sidebar.markdown("---")
st.sidebar.caption("üîß Kalibrace re√°ln√©ho dojezdu")
# Koeficient 1.8 zahrnuje rozjezdy, brzdƒõn√≠ a boƒçn√≠ v√≠tr (z praxe)
koeficient_realnosti = st.sidebar.slider("Koeficient n√°roƒçnosti", 1.0, 3.0, 1.8, 0.1)

st.sidebar.header("üîã 2) Baterie a Motor")
napeti_v = st.sidebar.number_input("Napƒõt√≠ baterie [V]", value=36)
kapacita_wh = st.sidebar.number_input("Kapacita baterie [Wh]", value=500)

nazev_rezimu = st.sidebar.selectbox("Re≈æim asistence", list(REZIMY_ASISTENCE.keys()), index=1)
support_ratio = REZIMY_ASISTENCE[nazev_rezimu]

vykon_motoru_nom = st.sidebar.number_input("Nomin√°ln√≠ v√Ωkon motoru [W]", value=250)

st.sidebar.header("‚òÄÔ∏è 3) Sol√°r a Lokalita")
vykon_panelu_wp = st.sidebar.number_input("Nomin√°ln√≠ v√Ωkon solar. panelu [Wp]", value=100)
lokalita = st.sidebar.selectbox("Lokalita", list(LOKALITA_DATA.keys()))

if lokalita == "Vlastn√≠ nastaven√≠":
    sklon_proc = st.sidebar.slider("Ter√©n - Sklon [%]", -5.0, 15.0, 0.0)
    dodana_energie_wh = st.sidebar.number_input("Dodan√° energie z osvitu [Wh]", value=150)
else:
    data = LOKALITA_DATA[lokalita]
    sklon_proc = data["sklon"]
    osvit_regionu = data["osvit"]
    dodana_energie_wh = vykon_panelu_wp * osvit_regionu * EFF_PANEL
    st.sidebar.info(f"üìç {lokalita}: Sklon {sklon_proc}%")


# ==============================================================================
# --- V√ùPOƒåTY (DETAILN√ç ROZBOR) ---
# ==============================================================================

# P≈ôevod rychlosti z km/h na m/s (fyzik√°ln√≠ vzorce pracuj√≠ s metry za sekundu)
v_ms = rychlost_kmh / 3.6

# --- 1. V√ùPOƒåET ODPOROV√ùCH SIL (Newtony) ---
# F_air: Odpor vzduchu. Roste s druhou mocninou rychlosti (proto je rychl√° j√≠zda tak n√°roƒçn√°).
# Vzorec: 0.5 * hustota_vzduchu * rychlost^2 * aerodynamick√Ω_koeficient
F_air = 0.5 * RHO * (v_ms**2) * CDA

# F_roll: Valiv√Ω odpor. T≈ôen√≠ pneumatik o silnici. Z√°vis√≠ na v√°ze a typu pneu (CRR).
# Vzorec: hmotnost * gravitace * koeficient_valen√≠
F_roll = hmotnost * G * CRR

# F_slope: Odpor stoup√°n√≠ (Gravitaƒçn√≠ slo≈æka). S√≠la, kter√° tƒõ t√°hne zp√°tky dol≈Ø z kopce.
# Vzorec: hmotnost * gravitace * sinus √∫hlu stoup√°n√≠
F_slope = hmotnost * G * math.sin(math.atan(sklon_proc/100))

# F_total: Celkov√° s√≠la, kterou mus√≠≈° p≈ôekonat, aby se kolo h√Ωbalo dop≈ôedu.
F_total = F_air + F_roll + F_slope
if F_total < 0: F_total = 0  # Pokud jedeme z kopce a s√≠la je z√°porn√°, nastav√≠me 0 (brzd√≠me)

# --- 2. V√ùPOƒåET MECHANICK√âHO V√ùKONU (Watty) ---
# P_mech_total: Teoretick√Ω v√Ωkon pot≈ôebn√Ω k udr≈æen√≠ rychlosti v laboratorn√≠ch podm√≠nk√°ch.
# Vzorec: S√≠la (N) * Rychlost (m/s)
P_mech_total = F_total * v_ms

# P_mech_real: Re√°ln√Ω v√Ωkon. Zde aplikujeme tv≈Øj "Koeficient n√°roƒçnosti" (1.8).
# Zohled≈àuje, ≈æe v re√°lu neust√°le brzd√≠≈°, rozj√≠≈æd√≠≈° se, fouk√° v√≠tr a silnice nen√≠ hladk√°.
P_mech_real = P_mech_total * koeficient_realnosti

# --- 3. ROZDƒöLEN√ç PR√ÅCE (MOTOR vs. ƒåLOVƒöK) ---
# Zde se rozhoduje, kdo tu d≈ôinu (P_mech_real) odd≈ôe.

if P_mech_real > 0:
    # support_ratio: ƒå√≠slo z nastaven√≠ asistence (nap≈ô. 0.5 pro Eco, 3.0 pro Boost).
    # Vzorec vych√°z√≠ z logiky: V√Ωkon_celkem = V√Ωkon_lidi + (V√Ωkon_lidi * asistence)
    P_human = P_mech_real / (1 + support_ratio) # Kolik mus√≠≈° ≈°lapat ty
    P_motor_req = P_mech_real - P_human         # Zbytek, kter√Ω chceme po motoru
else:
    P_human = 0
    P_motor_req = 0

# --- 4. ELEKTRICK√Å SPOT≈òEBA (BATERIE) ---
# P_motor_final: O≈ô√≠znut√≠ po≈æadavku. Motor nem≈Ø≈æe d√°t v√≠c ne≈æ sv≈Øj nomin√°ln√≠ v√Ωkon (nap≈ô. 250 W).
# Funkce min() vybere men≈°√≠ z ƒç√≠sel: buƒè to co pot≈ôebujeme, nebo maxim√°lku motoru.
P_motor_final = min(P_motor_req, vykon_motoru_nom)

# P_elec_battery: Kolik Watt≈Ø re√°lnƒõ teƒçe z baterky.
# Mus√≠me vydƒõlit √∫ƒçinnost√≠ (0.85), proto≈æe motor h≈ôeje. 
# Aby dal 250W mechanicky, vezme si cca 294W elektricky.
P_elec_battery = P_motor_final / EFF_MOTOR

# Korekce pro ƒçlovƒõka: Pokud motor narazil na limit (nest√≠h√° do kopce),
# mus√≠≈° ten chybƒõj√≠c√≠ v√Ωkon do≈°lapat ty nohama nav√≠c.
if P_motor_req > vykon_motoru_nom:
    P_human = P_mech_real - P_motor_final

# --- 5. V√ùPOƒåET DOJEZDU (Kilometry) ---
# spotreba_wh_km: Kolik energie "se≈æere" ujet√≠ 1 kilometru.
# Vzorec: V√Ωkon (W) / Rychlost (km/h)
spotreba_wh_km = P_elec_battery / rychlost_kmh if rychlost_kmh > 0 else 0

# dojezd_bat: Kolik km ujede≈° jen na baterii.
# Vzorec: Kapacita baterie (Wh) / Spot≈ôeba na km (Wh/km)
dojezd_bat = kapacita_wh / spotreba_wh_km if spotreba_wh_km > 0 else 0

# dojezd_solar: Kolik km ujede≈°, kdy≈æ k baterii p≈ôiƒçteme energii ze slunce.
dojezd_solar = (kapacita_wh + dodana_energie_wh) / spotreba_wh_km if spotreba_wh_km > 0 else 0

# Bonusov√© kilometry d√≠ky panelu
bonus_km = dojezd_solar - dojezd_bat

# ==============================================================================
# --- KONEC V√ùPOƒåT≈Æ ---
# ==============================================================================

# --- DASHBOARD (ZOBRAZEN√ç) ---
st.title("üîã Solar Bike Thesis: Kalibrace")
st.markdown(f"**Nastaven√≠:** {nazev_rezimu} | **Baterie:** {kapacita_wh} Wh")

m1, m2, m3 = st.columns(3)
m1.metric("Spot≈ôeba energie", f"{spotreba_wh_km:.1f} Wh/km")
m2.metric("Dojezd (Jen Baterie)", f"{dojezd_bat:.1f} km")
m3.metric("Dojezd (+ Sol√°r)", f"{dojezd_solar:.1f} km", delta=f"+{bonus_km:.1f} km")

st.divider()

c_graf, c_info = st.columns([2, 1])

with c_graf:
    st.subheader("Simulace dojezdu")
    df = pd.DataFrame({'Zdroj': ['Jen Baterie', 'Baterie + Sol√°r'], 'Dojezd (km)': [dojezd_bat, dojezd_solar]})
    st.bar_chart(df.set_index('Zdroj'))

with c_info:
    st.subheader("V√Ωkonov√° bilance")
    st.write(f"üö¥ **Jezdec (Nohy):** {P_human:.0f} W")
    st.write(f"‚ö° **Motor (H≈ô√≠del):** {P_motor_final:.0f} W")
    st.write(f"üîã **Odbƒõr z baterie:** {P_elec_battery:.0f} W")
    st.markdown("---")
    st.caption(f"Fyzik√°ln√≠ z√°klad: {P_mech_total:.0f} W")
    st.caption(f"Po kalibraci (1.8x): {P_mech_real:.0f} W")
